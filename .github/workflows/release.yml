name: Release Charts

on:
  push:
    branches:
      - master

jobs:
  test:
    uses: "charlie-haley/traefik-helm-chart-mirror/.github/workflows/test.yml@master"
  release:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
          git config --global --add safe.directory /charts

      - name: "Build Changelog"
        id: build_changelog
        uses: mikepenz/release-changelog-builder-action@v3.3.1
        with:
          configurationJson: |
            {
              "template": "#{{CHANGELOG}}\n\n<details>\n<summary>Uncategorized</summary>\n\n#{{UNCATEGORIZED}}\n</details>",
              "categories": [
                  {
                    "title": "## 🚀 Features",
                    "labels": ["kind/enhancement"]
                  },
                  {
                    "title": "## 🐛 Fixes",
                    "labels": ["kind/bug/fix"]
                  },
                  {
                    "title": "## 📝 Documentation",
                    "labels": ["area/documentation"]
                  }
              ]
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Save changelog to file
        run: echo "${{steps.build_changelog.outputs.changelog}}" > CHANGELOG

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.4.1
        with:
          config: ./.github/chart-releaser.yaml
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          CR_RELEASE_NOTES_FILE: "./CHANGELOG"
  copy:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Copy index.md to gh-pages
        uses: ./.github/actions/copy
        with:
          destination_branch: "gh-pages"
          file: ./index.md

      - name: Copy artifacthub-repo.yml to gh-pages
        uses: ./.github/actions/copy
        with:
          destination_branch: "gh-pages"
          file: ./artifacthub-repo.yml
